{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "environmentReference": {
            "type": "secureObject"
        },
        "vmName": {
            "type": "string"
        }
    },
    "variables": {
        "MSAntiMalware": [
            {
                "name": "Microsoft.Azure.Security",
                "properties": {
                    "publisher": "Microsoft.Azure.Security",
                    "settings": {
                        "RealtimeProtectionEnabled": "true"
                    },
                    "type": "IaasAntimalware",
                    "typeHandlerVersion": "1.5"
                }
            }
        ],
        "MSTrendMicro": [
            {
                "name": "TrendMicro.DeepSecurity",
                "properties": {
                    "publisher": "TrendMicro.DeepSecurity",
                    "type": "TrendMicroDSA",
                    "typeHandlerVersion": "9.6"
                },
                "settings": {
                    "DSMname": "[parameters('vmName')]",
                    "DSMport": "4120"
                },
                "protectedSettings": {
                    "tenantID": "NA",
                    "tenantPassword": "NA"
                }
            }
        ],
        "LinuxTrendMicro": [
            {
                "name": "TrendMicro.DeepSecurity",
                "properties": {
                    "publisher": "TrendMicro.DeepSecurity",
                    "type": "TrendMicroDSALinux",
                    "typeHandlerVersion": "9.6"
                },
                "settings": {
                    "DSMname": "[parameters('vmName')]",
                    "DSMport": "4120"
                },
                "protectedSettings": {
                    "tenantID": "NA",
                    "tenantPassword": "NA"
                }
            }
        ],
        "extensionReference": "placeholder",
        "paasPrefix": "[concat(parameters('environmentReference').deployment.prefix, '-', parameters('environmentReference').deployment.env)]",
        "kvUri": "[concat('https://', variables('paasPrefix'), '-kv.vault.azure.net/')]",
        "kvId": "[resourceId(concat(parameters('environmentReference').deployment.prefix, '-', parameters('environmentReference').deployment.env, '-operations'), 'Microsoft.KeyVault/vaults', concat(variables('paasPrefix'), '-kv'))]",
        "bkpName": "[concat(variables('paasPrefix'), '-bkp')]",
        "automationName": "[concat(variables('paasPrefix'), '-automation')]",
        "omsName": "[concat(variables('paasPrefix'), '-oms')]",
        "backupFabric": "Azure",
        "v2VmType": "Microsoft.Compute/virtualMachines",
        "v2VmContainer": "iaasvmcontainer;iaasvmcontainerv2;",
        "v2Vm": "vm;iaasvmcontainerv2;"
    },
    "resources": [
        {
            "condition": false,
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(parameters('vmName'),'/omsAgent')]",
            "apiVersion": "2016-03-30",
            "location": "[parameters('environmentReference').deployment.location]",
            "properties": {
                "publisher": "Microsoft.EnterpriseCloud.Monitoring",
                "type": "MicrosoftMonitoringAgent",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "workspaceId": "[reference(resourceId(concat(parameters('environmentReference').deployment.prefix, '-', parameters('environmentReference').deployment.env, '-operations'),'microsoft.operationalinsights/workspaces',variables('omsName')), '2015-03-20').customerId]"
                },
                "protectedSettings": {
                    "workspaceKey": "[listKeys(resourceId(concat(parameters('environmentReference').deployment.prefix, '-', parameters('environmentReference').deployment.env, '-operations'),'microsoft.operationalinsights/workspaces',variables('omsName')), '2015-03-20').primarySharedKey]"
                }
            }
        },
        {
            "condition": false,
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(parameters('vmName'),'/azureNetworkWatcher')]",
            "apiVersion": "2016-03-30",
            "location": "[parameters('environmentReference').deployment.location]",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'omsAgent')]"
            ],
            "properties": {
                "publisher": "Microsoft.Azure.NetworkWatcher",
                "type": "NetworkWatcherAgentWindows",
                "typeHandlerVersion": "1.4",
                "autoUpgradeMinorVersion": true
            }
        },
        {
            "condition": false,
            "apiVersion": "2016-03-30",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(parameters('vmName'),'/serviceMap')]",
            "location": "[parameters('environmentReference').deployment.location]",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'azureNetworkWatcher')]"
            ],
            "properties": {
                "publisher": "Microsoft.Azure.Monitoring.DependencyAgent",
                "type": "DependencyAgentWindows",
                "typeHandlerVersion": "9.1",
                "autoUpgradeMinorVersion": true
            }
        },
        {
            "condition": false,
            "apiVersion": "2017-05-10",
            "name": "[concat('backup-', parameters('vmName'))]",
            "type": "Microsoft.Resources/deployments",
            "resourceGroup": "[concat(parameters('environmentReference').deployment.prefix, '-', parameters('environmentReference').deployment.env, '-operations')]",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'serviceMap')]"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "name": "[concat(variables('bkpName'), '/', variables('backupFabric'), '/', variables('v2VmContainer'), resourceGroup().name, ';', parameters('vmName'), '/', variables('v2Vm'), resourceGroup().name, ';', parameters('vmName'))]",
                            "apiVersion": "2016-06-01",
                            "location": "[parameters('environmentReference').deployment.location]",
                            "type": "Microsoft.RecoveryServices/vaults/backupFabrics/protectionContainers/protectedItems",
                            "properties": {
                                "protectedItemType": "[variables('v2VmType')]",
                                "policyId": "[resourceId(resourceGroup().name, 'Microsoft.RecoveryServices/vaults/backupPolicies', variables('bkpName'), 'DefaultPolicy' )]",
                                "sourceResourceId": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                            }
                        }
                    ]
                }
            }
        },
        {
            "name": "[concat(parameters('vmName'), '-encryptionnested')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "dependsOn": [
                "[concat('backup-', parameters('vmName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/201-encrypt-running-windows-vm/azuredeploy.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "vmName": {
                        "value": "[parameters('vmName')]"
                    },
                    "aadClientID": {
                        "value": "[parameters('environmentReference').deployment.azureApplication]"
                    },
                    "aadClientSecret": {
                        "value": "[substring(parameters('environmentReference').deployment.buildingBlocksEndpoint, 8, 24)]"
                    },
                    "keyVaultName": {
                        "value": "[concat(variables('paasPrefix'), '-kv')]"
                    },
                    "keyVaultResourceGroup": {
                        "value": "[concat(parameters('environmentReference').deployment.prefix, '-', parameters('environmentReference').deployment.env, '-operations')]"
                    },
                    "useExistingKek": {
                        "value": "kek"
                    },
                    "keyEncryptionKeyURL": {
                        "value": "[concat(variables('kvUri'), 'keys/ContosoMasterKey/', parameters('environmentReference').deployment.keyVersion)]"
                    }
                }
            }
        }
    ]
}