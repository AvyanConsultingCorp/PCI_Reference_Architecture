{
    "$schema": "http://schema.management.azure.com/schemas/2014-04-01-preview/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "deploymentPrefix": {
            "type": "string"
        },
        "location": {
            "type": "string"
        },
        "resourceGroupPrefix": {
            "type": "string"
        }
    },
    "variables": {
        "solutionTypes": [
            "AntiMalware",
            "AzureActivity",
            "AzureAutomation",
            "AzureNSGAnalytics",
            "ChangeTracking",
            "KeyVaultAnalytics",
            "ServiceMap",
            "Security",
            "SQLAssessment",
            "Updates"
        ],
        "paasPrefix": "[concat(parameters('resourceGroupPrefix'), '-', parameters('deploymentPrefix'))]",
        "kvName": "[concat(variables('paasPrefix'), '-kv')]",
        "bkpName": "[concat(variables('paasPrefix'), '-bkp')]",
        "automationName": "[concat(variables('paasPrefix'), '-automation')]",
        "omsName": "[concat(variables('paasPrefix'), '-oms')]"
    },
    "resources": [
        {
            "apiVersion": "2016-10-01",
            "name": "[variables('kvName')]",
            "location": "[resourceGroup().location]",
            "type": "Microsoft.KeyVault/vaults",
            "properties": {
                "enabledForDeployment": false,
                "enabledForTemplateDeployment": true,
                "enabledForDiskEncryption": true,
                "accessPolicies": [],
                "tenantId": "[subscription().tenantId]",
                "sku": {
                    "name": "Premium",
                    "family": "A"
                }
            }
        },
        {
            "apiVersion": "2015-11-01-preview",
            "type": "Microsoft.OperationalInsights/workspaces",
            "name": "[variables('omsName')]",
            "location": "[parameters('location')]",
            "properties": {
                "sku": {
                    "Name": "Free"
                }
            }
        },
        {
            "name": "[variables('automationName')]",
            "type": "Microsoft.Automation/automationAccounts",
            "apiVersion": "2015-01-01-preview",
            "location": "[resourceGroup().location]",
            "dependsOn": [],
            "tags": {},
            "properties": {
                "sku": {
                    "name": "Basic"
                }
            }
        },
        {
            "id": "[concat(resourceGroup().id, '/providers/Microsoft.OperationsManagement/solutions/', variables('solutionTypes')[copyIndex()], '(', variables('omsName'), ')')]",
            "type": "Microsoft.OperationsManagement/solutions",
            "name": "[concat(variables('solutionTypes')[copyIndex()], '(', variables('omsName'), ')')]",
            "apiVersion": "2015-11-01-preview",
            "dependsOn": [
                "[concat('Microsoft.OperationalInsights/workspaces', '/' , variables('omsName'))]"
            ],
            "location": "[parameters('location')]",
            "copy": {
                "name": "solutionsCopy",
                "count": "[length(variables('solutionTypes'))]"
            },
            "plan": {
                "name": "[concat(variables('solutionTypes')[copyIndex()], '(', variables('omsName'), ')')]",
                "product": "[concat('OMSGallery/', variables('solutionTypes')[copyIndex()])]",
                "promotionCode": "",
                "publisher": "Microsoft"
            },
            "properties": {
                "workspaceResourceId": "[concat(resourceGroup().id, '/providers/Microsoft.OperationalInsights/workspaces/', variables('omsName'))]"
            }
        },
        {
            "id": "[concat(resourceGroup().id, '/providers/Microsoft.OperationalInsights/workspaces/', variables('omsName'), '/datasources/', subscription().subscriptionId)]",
            "type": "Microsoft.OperationalInsights/workspaces/datasources",
            "kind": "AzureActivityLog",
            "name": "[concat(variables('omsName'), '/', subscription().subscriptionId)]",
            "apiVersion": "2015-11-01-preview",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[concat('Microsoft.OperationalInsights/workspaces', '/' , variables('omsName'))]"
            ],
            "properties": {
                "linkedResourceId": "[concat(subscription().Id, '/providers/microsoft.insights/eventTypes/management')]"
            }
        },
        {
            "apiVersion": "2016-06-01",
            "name": "[variables('bkpName')]",
            "location": "[parameters('location')]",
            "type": "Microsoft.RecoveryServices/vaults",
            "sku": {
                "name": "RS0",
                "tier": "Standard"
            },
            "properties": {}
        }
    ]
}