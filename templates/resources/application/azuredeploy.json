{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"deploymentPrefix": {
			"type": "string"
		},
		"location": {
			"type": "string"
		},
		"resourceGroupPrefix": {
			"type": "string"
		},
		"environmentReference": {
			"type": "object"
		},
		"networkReference": {
			"type": "array"
		},
		"vmReference": {
			"type": "array"
		}
	},
	"variables": {
		"sqlDiskSize": 1000,
		"sqlNamePrefix": "[concat(parameters('deploymentPrefix'),'-sql-')]",
		"sqlLBName": "[concat(variables('sqlNamePrefix'),'ilb')]",
		"lbFrontEnd": "[concat(variables('sqlNamePrefix'),'lbFrontEnd')]",
		"lbBackEnd": "[concat(variables('sqlNamePrefix'),'lbBackEnd')]",
		"lbId": "[resourceId('Microsoft.Network/loadBalancers',variables('sqlLBName'))]",
		"lbFrontEndConfigId": "[concat(variables('lbId'),'/frontendIPConfigurations/',variables('lbFrontEnd'))]",
		"lbBackEndAddressPoolId": "[concat(variables('lbId'),'/backendAddressPools/',variables('lbBackEnd'))]",
		"lbProbeId": "[concat(variables('lbId'),'/probes/sqlProbe')]",
		"sqlAOListener": "[concat(parameters('deploymentPrefix'),'sql-agListener')]",
		"subnetUri": "[resourceId(concat(parameters('resourceGroupPrefix'), '-', parameters('deploymentPrefix'), '-networking'), 'Microsoft.Network/virtualNetworks/Subnets', concat(parameters('deploymentPrefix'), '-', variables('network').name), last(variables('network').subnets).subnetName)]",
		"network": "[last(parameters('networkReference'))]",
		"addressSpace": "[last(variables('network').subnets).addressSpacePrefix]",
		"substring": "[substring(variables('addressSpace'), 0, sub(length(variables('addressSpace')), 4))]",
		"listenerIp": "[concat(variables('substring'), 10)]"
	},
	"resources": [
		{
			"type": "Microsoft.Compute/availabilitySets",
			"name": "[concat(parameters('deploymentPrefix'),'-sql-as')]",
			"apiVersion": "2016-04-30-preview",
			"location": "[resourceGroup().location]",
			"properties": {
				"platformFaultDomainCount": 2,
				"platformUpdateDomainCount": 5,
				"managed": true
			}
		},
		{
			"apiVersion": "2015-06-15",
			"name": "[variables('sqlLBName')]",
			"type": "Microsoft.Network/loadBalancers",
			"location": "[resourceGroup().location]",
			"dependsOn": [],
			"properties": {
				"frontendIPConfigurations": [
					{
						"name": "[variables('lbFrontEnd')]",
						"properties": {
							"privateIPAllocationMethod": "Static",
							"privateIPAddress": "[variables('listenerIp')]",
							"subnet": {
								"id": "[variables('subnetUri')]"
							}
						}
					}
				],
				"backendAddressPools": [
					{
						"name": "[variables('lbBackEnd')]"
					}
				],
				"loadBalancingRules": [
					{
						"name": "[variables('sqlAOListener')]",
						"properties": {
							"frontendIPConfiguration": {
								"id": "[variables('lbFrontEndConfigId')]"
							},
							"backendAddressPool": {
								"id": "[variables('lbBackEndAddressPoolId')]"
							},
							"probe": {
								"id": "[variables('lbProbeId')]"
							},
							"protocol": "Tcp",
							"frontendPort": 1433,
							"backendPort": 1433,
							"enableFloatingIP": true
						}
					}
				],
				"probes": [
					{
						"name": "sqlProbe",
						"properties": {
							"protocol": "Tcp",
							"port": 59999,
							"intervalInSeconds": 5,
							"numberOfProbes": 2
						}
					}
				]
			}
		},
		{
			"name": "[concat(variables('sqlNamePrefix'), copyindex(), '-nic')]",
			"type": "Microsoft.Network/networkInterfaces",
			"location": "[resourceGroup().location]",
			"apiVersion": "2015-06-15",
			"copy": {
				"name": "nicLoop",
				"count": "[parameters('environmentReference').sqlVmCount]"
			},
			"dependsOn": [
				"[variables('lbId')]"
			],
			"properties": {
				"ipConfigurations": [
					{
						"name": "primary",
						"properties": {
							"privateIPAllocationMethod": "Dynamic",
							"subnet": {
								"id": "[variables('subnetUri')]"
							},
							"loadBalancerBackendAddressPools": [
								{
									"id": "[variables('lbBackEndAddressPoolId')]"
								}
							],
							"primary": true
						}
					},
					{
						"name": "cluster",
						"properties": {
							"privateIPAllocationMethod": "Dynamic",
							"subnet": {
								"id": "[variables('subnetUri')]"
							}
						}
					}
				]
			}
		},
		{
			"apiVersion": "2016-04-30-preview",
			"type": "Microsoft.Compute/virtualMachines",
			"name": "[concat(variables('sqlNamePrefix'), copyindex())]",
			"location": "[resourceGroup().location]",
			"copy": {
				"name": "virtualMachineLoop",
				"count": "[parameters('environmentReference').sqlVmCount]"
			},
			"dependsOn": [
				"[resourceId('Microsoft.Network/networkInterfaces',concat(variables('sqlNamePrefix'), copyindex(), '-nic'))]",
				"[concat(parameters('deploymentPrefix'),'-sql-as')]"
			],
			"properties": {
				"hardwareProfile": {
					"vmSize": "Standard_DS2_v2"
				},
				"availabilitySet": {
					"id": "[resourceId('Microsoft.Compute/availabilitySets', concat(parameters('deploymentPrefix'),'-sql-as'))]"
				},
				"osProfile": {
					"computerName": "[concat(variables('sqlNamePrefix'), copyindex())]",
					"adminUsername": "[parameters('environmentReference').serviceAccess]",
					"adminPassword": "[parameters('environmentReference').serviceAccessPwD]"
				},
				"storageProfile": {
					"imageReference": {
						"publisher": "MicrosoftSQLServer",
						"offer": "SQL2016SP1-WS2016",
						"sku": "Enterprise",
						"version": "latest"
					},
					"osDisk": {
						"name": "[concat(variables('sqlNamePrefix'), copyindex(), '-osdisk.vhd')]",
						"caching": "ReadWrite",
						"createOption": "FromImage",
						"managedDisk": {
							"storageAccountType": "Premium_LRS"
						}
					},
					"copy": [
						{
							"name": "dataDisks",
							"count": "[parameters('environmentReference').sqlDiskCount]",
							"input": {
								"name": "[concat(variables('sqlNamePrefix'), copyindex('virtualMachineLoop'), '-dd', copyindex('dataDisks'))]",
								"caching": "None",
								"createOption": "Empty",
								"diskSizeGB": "[variables('sqlDiskSize')]",
								"lun": "[copyindex('dataDisks')]",
								"managedDisk": {
									"storageAccountType": "Premium_LRS"
								}
							}
						}
					]
				},
				"networkProfile": {
					"networkInterfaces": [
						{
							"id": "[resourceId('Microsoft.Network/networkInterfaces',concat(variables('sqlNamePrefix'), copyindex(), '-nic'))]"
						}
					]
				},
				"diagnosticsProfile": {
					"bootDiagnostics": {
						"enabled": true,
						"storageUri": "[reference(resourceId(concat(parameters('resourceGroupPrefix'), '-', parameters('deploymentPrefix'), '-operations'), 'Microsoft.Storage/storageAccounts', concat(parameters('resourceGroupPrefix'), parameters('deploymentPrefix'), 'diagstor')), '2015-06-15').primaryEndpoints['blob']]"
					}
				}
			},
			"resources": [
				{
					"name": "SqlIaasExtension",
					"type": "extensions",
					"apiVersion": "2016-03-30",
					"location": "[parameters('location')]",
					"dependsOn": [
						"[concat(variables('sqlNamePrefix'), copyindex())]"
					],
					"properties": {
						"publisher": "Microsoft.SqlServer.Management",
						"type": "SqlIaaSAgent",
						"typeHandlerVersion": "1.2",
						"autoUpgradeMinorVersion": true,
						"settings": {
							"AutoTelemetrySettings": {
								"Region": "[parameters('location')]"
							},
							"AutoPatchingSettings": {
								"PatchCategory": "WindowsMandatoryUpdates",
								"Enable": false,
								"DayOfWeek": "Sunday",
								"MaintenanceWindowStartingHour": "2",
								"MaintenanceWindowDuration": "60"
							},
							"KeyVaultCredentialSettings": {
								"Enable": false,
								"CredentialName": "sysadmin_ekm_cred"
							},
							"ServerConfigurationsManagementSettings": {
								"SQLConnectivityUpdateSettings": {
									"ConnectivityType": "Private",
									"Port": 1433
								},
								"SQLWorkloadTypeUpdateSettings": {
									"SQLWorkloadType": "GENERAL"
								},
								"SQLStorageUpdateSettings": {
									"DiskCount": "[parameters('environmentReference').sqlDiskCount]",
									"NumberOfColumns": "[parameters('environmentReference').sqlDiskCount]",
									"StartingDeviceID": 2,
									"DiskConfigurationType": "NEW"
								}
							}
						},
						"protectedSettings": {
							"PrivateKeyVaultCredentialSettings": {
								"AzureKeyVaultUrl": "https://ror.lol",
								"ServicePrincipalName": "1qazxsW@",
								"ServicePrincipalSecret": "1qazxsW@"
							}
						}
					}
				}
			]
		},
		{
			"type": "Microsoft.Compute/virtualMachines/extensions",
			"name": "[concat(variables('sqlNamePrefix'),copyindex(1),'/sql-alwayson')]",
			"apiVersion": "2016-03-30",
			"location": "[resourceGroup().location]",
			"dependsOn": [
				"[resourceId('Microsoft.Compute/virtualMachines/extensions', concat(variables('sqlNamePrefix'), copyIndex(1)), 'SqlIaasExtension')]"
			],
			"copy": {
				"name": "virtualMachineExtensionLoop",
				"count": "[sub(parameters('environmentReference').sqlVmCount, 1)]"
			},
			"properties": {
				"publisher": "Microsoft.Powershell",
				"type": "DSC",
				"typeHandlerVersion": "2.20",
				"autoUpgradeMinorVersion": true,
				"settings": {
					"configuration": {
						"url": "[concat(parameters('environmentReference').buildingBlocksEndpoint, 'packages/sql-alwayson.zip')]",
						"script": "sql-alwayson.ps1",
						"function": "sql-secondary"
					},
					"configurationArguments": {
						"deploymentPrefix": "[parameters('deploymentPrefix')]",
						"domainName": "[parameters('environmentReference').domainName]"
					}
				},
				"protectedSettings": {
					"configurationArguments": {
						"adminCreds": {
							"userName": "[parameters('environmentReference').serviceAccess]",
							"password": "[parameters('environmentReference').serviceAccessPwd]"
						},
						"sqlServiceCreds": {
							"userName": "[concat(parameters('environmentReference').serviceAccess, '-sql')]",
							"password": "[parameters('environmentReference').serviceAccessPwd]"
						}
					}
				}
			}
		},
		{
			"type": "Microsoft.Compute/virtualMachines/extensions",
			"name": "[concat(variables('sqlNamePrefix'),'0/sql-alwayson')]",
			"apiVersion": "2016-03-30",
			"location": "[resourceGroup().location]",
			"dependsOn": [
				"[resourceId('Microsoft.Compute/virtualMachines/extensions', concat(variables('sqlNamePrefix'), '0'), 'SqlIaasExtension')]"
			],
			"properties": {
				"publisher": "Microsoft.Powershell",
				"type": "DSC",
				"typeHandlerVersion": "2.20",
				"autoUpgradeMinorVersion": true,
				"settings": {
					"configuration": {
						"url": "[concat(parameters('environmentReference').buildingBlocksEndpoint, 'packages/sql-alwayson.zip')]",
						"script": "sql-alwayson.ps1",
						"function": "sql-primary"
					},
					"configurationArguments": {
						"deploymentPrefix": "[parameters('deploymentPrefix')]",
						"domainName": "[parameters('environmentReference').domainName]",
						"SqlAlwaysOnAvailabilityGroupListenerIp": "[variables('listenerIp')]",
						"bacpacUri": "[parameters('environmentReference').bacpacUri]"
					}
				},
				"protectedSettings": {
					"configurationArguments": {
						"witnessAccount": {
							"userName": "[concat(parameters('resourceGroupPrefix'), parameters('deploymentPrefix'), 'diagstor')]",
							"password": "[listKeys(resourceId(concat(parameters('resourceGroupPrefix'), '-', parameters('deploymentPrefix'), '-operations'), 'Microsoft.Storage/storageAccounts', concat(parameters('resourceGroupPrefix'), parameters('deploymentPrefix'), 'diagstor')), '2016-01-01').keys[0].value]"
						},
						"adminCreds": {
							"userName": "[parameters('environmentReference').serviceAccess]",
							"password": "[parameters('environmentReference').serviceAccessPwd]"
						},
						"sqlServiceCreds": {
							"userName": "[concat(parameters('environmentReference').serviceAccess, '-sql')]",
							"password": "[parameters('environmentReference').serviceAccessPwd]"
						}
					}
				}
			}
		},
		{
		  "name": "[concat(variables('sqlNamePrefix'), 'extension-', copyindex())]",
		  "type": "Microsoft.Resources/deployments",
		  "apiVersion": "2017-05-10",
		  "dependsOn": [
			"[resourceId('Microsoft.Compute/virtualMachines/extensions', concat(variables('sqlNamePrefix'), copyIndex()), 'sql-alwayson')]"
		  ],
		  "copy": {
			"name": "extensions",
			"count": "[parameters('environmentReference').sqlVmCount]"
		  },
		  "properties": {
			"mode": "Incremental",
			"templateLink": {
			  "uri": "[concat(parameters('environmentReference').buildingBlocksEndpoint, 'application/nested_extensions.json')]",
			  "contentVersion": "1.0.0.0"
			},
			"parameters": {
			  "deploymentPrefix": {
				"value": "[parameters('deploymentPrefix')]"
			  },
			  "resourceGroupPrefix": {
				"value": "[parameters('resourceGroupPrefix')]"
			  },
			  "vmName": {
				"value": "[concat(variables('sqlNamePrefix'), copyIndex())]"
			  },
			  "location": {
				"value": "[parameters('location')]"
			  }
			}
		  }
		},
		{
			"name": "[concat(parameters('deploymentPrefix'), 'vmss-', copyIndex())]",
			"type": "Microsoft.Resources/deployments",
			"apiVersion": "2015-01-01",
			"copy": {
				"name": "vmssCopy",
				"count": "[length(parameters('vmReference'))]"
			},
			"properties": {
				"mode": "Incremental",
				"templateLink": {
					"uri": "[concat(parameters('environmentReference').buildingBlocksEndpoint, 'application/nested_vmss.json')]",
					"contentVersion": "1.0.0.0"
				},
				"parameters": {
					"bossObject": {
						"value": "[parameters('vmReference')[copyIndex()]]"
					},
					"location": {
						"value": "[parameters('location')]"
					},
					"deploymentPrefix": {
						"value": "[parameters('deploymentPrefix')]"
					},
					"resourceGroupPrefix": {
						"value": "[parameters('resourceGroupPrefix')]"
					},
					"environmentReference": {
						"value": "[parameters('environmentReference')]"
					},
					"networkReference": {
						"value": "[parameters('networkReference')]"
					}
				}
			}
		}
	]
}