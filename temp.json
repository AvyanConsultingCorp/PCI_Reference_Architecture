{
    "type": "Microsoft.Compute/virtualMachines/extensions",
    "name": "[concat(parameters('vmName'),'/encryption')]",
    "apiVersion": "2016-04-30-preview",
    "location": "[parameters('environmentReference').deployment.location]",
    "dependsOn": [
        "[concat('backup-', parameters('vmName'))]"
    ],
    "properties": {
        "publisher": "Microsoft.Azure.Security",
        "type": "AzureDiskEncryption",
        "typeHandlerVersion": "1.1",
        "autoUpgradeMinorVersion": true,
        "forceUpdateTag": "1.0",
        "settings": {
            "AADClientID": "[parameters('environmentReference').deployment.azureApplication]",
            "KeyVaultURL": "[variables('kvUri')]",
            "KeyEncryptionKeyURL": "[concat(variables('kvUri'), 'keys/ContosoMasterKey/', parameters('environmentReference').deployment.keyVersion)]",
            "KeyEncryptionAlgorithm": "RSA-OAEP",
            "VolumeType": "All",
            "EncryptionOperation": "EnableEncryption"
        },
        "protectedSettings": {
            "AADClientSecret": "[substring(parameters('environmentReference').deployment.buildingBlocksEndpoint, 8, 24)]"
        }
    }
},
{
    "apiVersion": "2016-04-30-preview",
    "type": "Microsoft.Compute/virtualMachines",
    "name": "[parameters('vmName')]",
    "location": "[resourceGroup().location]",
    "properties": {
        "storageProfile": {
            "osDisk": {
                "encryptionSettings": {
                    "diskEncryptionKey": {
                        "sourceVault": {
                            "id": "[variables('kvId')]"
                        },
                        "secretUrl": "[reference(resourceId('Microsoft.Compute/virtualMachines/extensions',  parameters('vmName'), 'encryption')).instanceView.statuses[0].message]"
                    },
                    "keyEncryptionKey": {
                        "sourceVault": {
                            "id": "[variables('kvId')]"
                        },
                        "keyUrl": "[concat(variables('kvUri'), '/keys/ContosoMasterKey/', parameters('environmentReference').deployment.keyVersion)]"
                    }
                }
            }
        }
    }
}